<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KI-Assistent | AnwaltsAI</title>
  <link rel="icon" href="/favicon.png" />
  <link rel="stylesheet" href="/shared/anwalts-integration.css" />
  <style>
    :root{
      --surface: var(--card-bg, #ffffff);
      --background: var(--app-bg, #f6f7fb);
      --border: var(--border, #e5e7eb);
      --text-900: var(--text-900, #0f172a);
      --muted: var(--text-600, #64748b);
      --brand-600: var(--primary-600, #6366f1);
      --brand-700: var(--primary-700, #4f46e5);
      --grad-from: var(--primary-grad-from, #6d5efc);
      --grad-to: var(--primary-grad-to, #2563eb);
    }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--background);
      color: var(--text-900);
    }
    .container { max-width: 960px; margin: 0 auto; padding: 20px 16px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); }
    
    .card-header { padding: 12px 14px; border-bottom: 1px solid var(--border); font-weight:600; font-size:14px; color: var(--muted); }
    .card-body { padding: 12px; }
    .page-header { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); padding: 12px 16px; display:flex; align-items:center; justify-content:space-between; margin-bottom: 20px; }
    .page-title { font-size: 18px; font-weight: 700; color: var(--text-900); margin: 0; }
    .tagline { color: var(--muted); font-size: 13px; }
    .threads-list { list-style: none; margin: 0; padding: 8px 0; }
    .thread-item { border-radius: 8px; padding: 8px 12px; display:flex; align-items:flex-start; justify-content:space-between; cursor: pointer; }
    .thread-item:hover { background: #f8fafc; }
    .search { width: 100%; height: 36px; padding: 6px 10px; border-radius: 8px; border:1px solid var(--border); background:#f8fafc; color: var(--text-900); }
    .chat-wrap { display:flex; flex-direction:column; }
    .transcript { height: min(60vh, calc(100vh - 360px)); overflow-y: auto; padding: 12px; background: var(--surface); border:1px solid var(--border); border-radius: 12px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); margin-top: 8px; }
    .bubble-user { max-width: 75%; margin-left: auto; background: #eef2ff; color: var(--text-900); border:1px solid #e0e7ff; border-radius: 14px; border-bottom-right-radius: 6px; padding: 10px 12px; }
    .bubble-ai { max-width: 75%; margin-right: auto; background: #ffffff; color: var(--text-900); border:1px solid var(--border); border-radius: 14px; border-bottom-left-radius: 6px; padding: 10px 12px; }
    .chip { display:inline-block; background:#f1f5f9; color:#475569; border-radius:9999px; padding:2px 8px; font-size:12px; }
    .composer { position: sticky; bottom: 8px; margin-top: 16px; background: var(--surface); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); padding: 8px; display:flex; gap: 8px; align-items:flex-end; }
    .textarea { flex:1; min-height:48px; max-height:180px; resize:vertical; background: transparent; border: none; outline: none; color: var(--text-900); padding: 8px 10px; }
    .btn-primary { display:inline-flex; align-items:center; justify-content:center; height: 44px; padding: 0 16px; border-radius: 12px; color: #fff; font-weight:600; background-image: linear-gradient(90deg, var(--grad-from), var(--grad-to)); border: none; cursor: pointer; }
    .btn-primary:disabled { opacity: .6; cursor: not-allowed; }
    .btn-ghost-sm { height: 36px; padding: 0 10px; border-radius: 10px; border:1px solid var(--border); background:#fff; color:var(--text-900); }
    .actions-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .examples { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .example-chip { background:#f1f5f9; border:1px solid var(--border); color:#334155; padding:6px 10px; border-radius:12px; cursor:pointer; font-size:12px; }
    .attach-btn { height: 32px; width:32px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:16px; }
    .previews { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .thumb { width:64px; height:64px; border:1px solid var(--border); border-radius:8px; object-fit:cover; background:#f8fafc; }
    .file-chip { border:1px solid var(--border); background:#fff; color:#334155; border-radius:9999px; padding:4px 8px; font-size:12px; }
    /* Dashboard footer look-and-feel */
    footer.glass-morphism { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; backdrop-filter: saturate(1.2) blur(12px); }
    footer.glass-morphism h3, footer.glass-morphism h4 { color: #ffffff; }
    footer.glass-morphism p { color: #9ca3af; }
    footer.glass-morphism a { color: #9ca3af; text-decoration: none; }
    footer.glass-morphism a:hover { color: #ffffff; }
    footer.glass-morphism hr { border-color: #4b5563; }
    footer.glass-morphism .text-gray-400 { color: #9ca3af; }
    footer.glass-morphism .text-gray-500 { color: #6b7280; }
    .footer-dark-wrap { width:100%; margin-top: 16px; padding: 12px 0; background: radial-gradient(120% 120% at 0% 0%, #0b1220 0%, #111827 40%, #0b1220 100%); }
    /* Assistant footer as white card matching Dashboard (blue links) */
    footer.assistant-footer.card { background:#ffffff; border:1px solid var(--border); border-radius:12px; box-shadow:0 1px 2px rgba(16,24,40,0.04); }
    footer.assistant-footer.card h3, footer.assistant-footer.card h4 { color:#0f172a; }
    footer.assistant-footer.card p { color:#6b7280; }
    footer.assistant-footer.card a { color:#2563eb; text-decoration:none; }
    footer.assistant-footer.card a:hover { color:#1d4ed8; }
    footer.assistant-footer.card hr { border-color:#e5e7eb; }
    /* Arrow-in-circle primary send button */
    .btn-send-circle{position:relative;display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:9999px;color:#fff;background-image:linear-gradient(90deg,var(--grad-from,#6d5efc),var(--grad-to,#2563eb));box-shadow:0 6px 16px rgba(37,99,235,.35);border:0;font-size:14px;}
    .btn-send-circle:hover{filter:saturate(1.05) brightness(1.02);box-shadow:0 12px 28px rgba(37,99,235,.45)}
    .btn-send-circle:focus{outline:none;box-shadow:0 0 0 3px rgba(99,102,241,.35),0 8px 20px rgba(37,99,235,.35)}
    .btn-send-circle.btn-stop{background-image:linear-gradient(90deg,#cbd5e1,#94a3b8)}
    /* Settings glassmorphism */
    .glass-sheet{background:rgba(255,255,255,.55);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.35);box-shadow:0 10px 30px rgba(15,23,42,.08);border-radius:16px}
    /* Message actions row */
    .msg-actions{display:flex;gap:8px;margin-top:6px;color:#64748b}
    .msg-actions button{height:28px;width:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#fff;cursor:pointer;transition:background .15s,border-color .15s,color .15s}
    .msg-actions button:hover{background:#f8fafc;border-color:#d1d5db;color:#0f172a}
    .msg-actions svg{width:16px;height:16px}
    /* Simple spinner for regen */
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .spin{animation:spin 1s linear infinite}
    /* Markdown formatting */
    .chat-markdown h1,.chat-markdown h2,.chat-markdown h3{font-weight:600;color:#0f172a;margin:12px 0 6px}
    .chat-markdown p{margin:8px 0;line-height:1.6}
    .chat-markdown code{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:0 4px}
    .chat-markdown pre{background:#0f172a;color:#e2e8f0;border-radius:10px;padding:14px;overflow:auto}
    .chat-markdown ul,.chat-markdown ol{margin:8px 0 8px 20px}
    .chat-markdown table{width:100%;border-collapse:collapse;margin:10px 0}
    .chat-markdown th,.chat-markdown td{border:1px solid #e5e7eb;padding:8px;text-align:left}

    /* Typing bubble (assistant) */
    .typing-bubble{max-width:80%;margin-right:auto;background:#ffffff;border:1px solid #e5e7eb;color:#334155;border-radius:16px 16px 16px 6px;padding:10px 12px;display:inline-flex;align-items:center;gap:6px}
    .typing-text{font-style:italic;color:#64748b}
    .typing-text::after{content:' ‚Ä¶';animation:typingDots 1.2s infinite steps(3,end)}
    @keyframes typingDots{0%{content:' .'}33%{content:' ..'}66%{content:' ...'}100%{content:' .'}}

    /* Guided pill toolbar */
    .pillbar { display:flex; flex-wrap:wrap; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; height:32px; padding:0 10px; border-radius:9999px; background:#f8fafc; border:1px solid var(--border); color: var(--text-900); font-size:12px; }
    .pill select { appearance:none; background:transparent; border:none; outline:none; color:inherit; font:inherit; }

    /* Onboarding banner */
    .banner { background: var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow: 0 1px 2px rgba(16,24,40,0.04); padding:14px 16px; display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
    .banner h2 { margin:0 0 4px 0; font-size:16px; font-weight:700; color: var(--text-900); }
    .banner p { margin:0; color: var(--muted); font-size:13px; }
    .btn-ghost { background:transparent; border:none; color: var(--muted); height:36px; padding:0 10px; border-radius:10px; cursor:pointer; }

    /* Drawers & responsiveness */
    .drawer-btn { display:none; height:32px; padding:0 10px; border-radius:8px; border:1px solid var(--border); background:#fff; color:var(--text-900); }
    .drawer { position:fixed; top:0; bottom:0; width:320px; right: -340px; background:#fff; border-left:1px solid var(--border); box-shadow: -8px 0 24px rgba(16,24,40,0.08); transition:right .25s ease; z-index: 50; display:flex; flex-direction:column; }
    .drawer.open { right: 0; }
    .drawer-header { padding:12px 14px; border-bottom:1px solid var(--border); font-weight:600; color:var(--muted); display:flex; align-items:center; justify-content:space-between; }
    .backdrop { position:fixed; inset:0; background:rgba(15,23,42,0.3); backdrop-filter: blur(2px); z-index: 40; display:none; }
    .backdrop.show { display:block; }

    /* Settings sheet sizing (content-fit, not full height) */
    #settingsSheet { top: 84px; right: -400px; bottom: auto; height: auto; max-height: 80vh; overflow: auto; border-radius: 16px; }
    #settingsSheet.open { right: 16px; }

    /* Breakpoints */
    @media (max-width: 1279px) { /* lg */
      .grid { grid-template-columns: 260px 1fr; }
      .context-aside { display:none; }
      .drawer-btn { display:inline-flex; align-items:center; }
    }
    @media (max-width: 1023px) { /* md */
      .grid { grid-template-columns: 1fr; }
      .threads-card { display:none; }
      .drawer-threads { left: -300px; right: auto; width: 280px; border-right:1px solid var(--border); border-left:none; }
      .drawer-threads.open { left: 0; }
    }
    @media (max-width: 767px) { /* sm */
      .container { padding: 16px 12px; }
      .page-header { padding:10px 12px; }
      .composer { position: sticky; bottom: 8px; }
      .bottom-tabs { position: fixed; bottom: 0; left: 0; right:0; background:#fff; border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:8px 0; z-index: 60; }
      .bottom-tabs button { background:transparent; border:none; color: var(--text-900); font-weight:600; }
      body { padding-bottom: 56px; }
    }
  </style>
  <script>
    // Unified auth token getter (localStorage and readable cookies)
    function getAuthToken(){
      try {
        const lsKeys = ['anwalts_auth_token','access_token','token'];
        for (const k of lsKeys){ const v = localStorage.getItem(k); if (v) return v; }
      } catch(_) {}
      try {
        const map = Object.fromEntries(document.cookie.split(';').map(s=>s.trim().split('=')));
        // Backend sets non-HttpOnly 'sat' on OAuth; prefer that
        if (map.sat) return decodeURIComponent(map.sat);
        if (map.access_token) return decodeURIComponent(map.access_token);
      } catch(_) {}
      return '';
    }
    async function ensureAuthToken(){
      let tok = getAuthToken();
      if (tok) return tok;
      try{
        // Probe auth; backend will validate cookies if present
        await fetch('/auth/me', { method: 'GET', credentials: 'include' });
        // Copy readable cookie to localStorage for Authorization header on protected endpoints
        const map = Object.fromEntries(document.cookie.split(';').map(s=>s.trim().split('=')));
        if (map.sat){
          localStorage.setItem('anwalts_auth_token', decodeURIComponent(map.sat));
          tok = map.sat;
        }
      }catch(_){ /* ignore */ }
      return tok || '';
    }
    // Enable Tailwind utilities without global resets (keep current sizes)
    window.tailwind = { config: { corePlugins: { preflight: false } } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="/shared/anwalts-navigation.js"></script>
</head>
<body>
  <div class="container">
    <div id="onboarding" class="banner" role="region" aria-label="Onboarding" style="display:none;">
      <div>
        <h2>KI-Assistent</h2>
        <p>In drei Schritten zum Ergebnis: 1) Ziel w√§hlen 2) Kontext hinzuf√ºgen 3) Senden</p>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="quickStartBtn" class="btn-primary" type="button">Schnellstart</button>
        <button id="dismissOnboarding" class="btn-ghost" type="button">Sp√§ter</button>
      </div>
    </div>

    <div class="page-header">
      <div>
        <h1 class="page-title">KI-Assistent</h1>
        <div class="tagline">Recherchieren, entwerfen und pr√ºfen ‚Äì mit KI-Unterst√ºtzung, RDG-konform.</div>
      </div>
      <div class="chips" style="display:flex; gap:8px; align-items:center;">
        <button id="privacyToggle" type="button" class="chip" aria-label="Sichtbarkeit umschalten">Nur ich</button>
        <span class="chip" title="Verarbeitung in EU-Rechenzentren">EU</span>
        <button id="openSettings" class="btn-ghost-sm" type="button" aria-label="Einstellungen">‚öôÔ∏è</button>
        <button id="toggleThreads" class="drawer-btn" type="button" aria-expanded="false" style="display:none;">Threads</button>
        <button id="toggleContext" class="drawer-btn" type="button" aria-expanded="false" style="display:none;">Kontext</button>
      </div>
    </div>

    <!-- Breadcrumb link to Dashboard -->
    <div class="tagline" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <a href="/dashboard" style="text-decoration:none; color:#475569; display:inline-flex; align-items:center; gap:6px;">‚åÇ Dashboard</a>
      <span>‚Ä∫</span>
      <span style="font-weight:600; color:#0f172a;">KI-Assistent</span>
    </div>
    <main role="main">
      <!-- SimpleChat: Single column chat -->
      <section class="chat-wrap">
        <div class="card" aria-labelledby="chat-title" style="margin-bottom:12px;">
          <div class="card-body" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div><strong id="thread-title">Neuer Chat</strong></div>
            <div class="pillbar" role="toolbar" aria-label="Assistent Optionen" id="pillbar" style="display:none;">
              <div class="pill"><span>Ziel</span>
                <select id="optMode" aria-label="Ziel">
                  <option>Entwurf</option>
                  <option>Recherche</option>
                  <option>Pr√ºfen</option>
                  <option>√úbersetzen</option>
                </select>
              </div>
              <div class="pill"><span>Rechtsraum</span>
                <select id="optJuris" aria-label="Rechtsraum">
                  <option>DE (BGB)</option>
                  <option>EU</option>
                  <option>AT</option>
                  <option>CH</option>
                </select>
              </div>
              <div class="pill"><span>Sprache</span>
                <select id="optLang" aria-label="Sprache">
                  <option>Deutsch</option>
                  <option>Englisch</option>
                </select>
              </div>
              <div class="pill"><span>Sichtbarkeit</span>
                <select id="optPrivacy" aria-label="Sichtbarkeit">
                  <option>Nur ich</option>
                  <option>Team</option>
                </select>
              </div>
              <div class="pill" title="Verarbeitung nur in EU-Rechenzentren">EU</div>
            </div>
          </div>
        </div>

        <div id="messages" class="transcript" role="log" aria-live="polite"></div>
        <div id="emptyState" class="card" style="margin-top:12px;">
          <div class="card-body">
            <div class="tagline" style="font-size:14px; color:var(--text-900); font-weight:600; margin-bottom:6px;">Womit kann ich helfen?</div>
            <div id="emptyChips" class="examples"></div>
          </div>
        </div>

        <!-- Inline composer -->
        <div class="composer" aria-label="Nachricht an die KI verfassen">
          <button class="attach-btn" id="attachBtn" title="Datei anh√§ngen" aria-label="Datei anh√§ngen">üìé</button>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.webp" style="display:none;" />
          <textarea id="input" class="textarea" placeholder="Frag die KI ‚Äì z. B. ‚ÄûWelche Punkte sollte eine beidseitige NDA enthalten?‚Äú" aria-label="Nachricht eingeben"></textarea>
          <button class="btn-send-circle" id="send" type="button" aria-label="Nachricht senden">‚Üó</button>
        </div>
        <div class="previews" id="previews"></div>
        <div class="examples" id="examples"></div>
        <div class="tagline" style="margin-top:8px; margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <span>Enter sendet ‚Ä¢ Shift+Enter Zeilenumbruch</span>
          <span>PDF/DOCX/TXT/PNG/JPG anheften ‚Ä¢ OCR verf√ºgbar</span>
          <span>Kein Rechtsrat im Einzelfall. Ergebnis pr√ºfen und freigeben.</span>
        </div>

        <!-- Assistant Footer (white card) -->
        <div>
          <footer class="assistant-footer card" style="max-width: 960px; margin: 16px auto 0; border: 1px solid #e5e7eb;">
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Company Info -->
                    <div class="md:col-span-1">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" preserveAspectRatio="xMidYMid meet">
                                    <path d="M12 2L2 7v10c0 5.55 3.84 9.95 9 11 5.16-1.05 9-5.45 9-11V7l-10-5z"/>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-slate-900">AnwaltsAI</h3>
                        </div>
                        <p class="text-slate-600 text-sm">Professional Legal AI Platform for modern law firms</p>
                        <div class="mt-4 text-xs text-slate-500">
                            <p>¬© 2025 AnwaltsAI. All rights reserved.</p>
                            <p>Version 1.0.0</p>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div>
                        <h4 class="text-slate-900 font-semibold mb-3">Quick Access</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="/dashboard" class="text-blue-600 hover:text-blue-700 transition-colors cursor-pointer">Dashboard</a></li>
                            <li><a href="/document-generator" class="text-blue-600 hover:text-blue-700 transition-colors cursor-pointer">Document Generator</a></li>
                            <li><a href="/emails" class="text-blue-600 hover:text-blue-700 transition-colors cursor-pointer">Email Portal</a></li>
                            <li><a href="/templates" class="text-blue-600 hover:text-blue-700 transition-colors cursor-pointer">Templates</a></li>
                        </ul>
                    </div>

                    <!-- Legal Resources -->
                    <div>
                        <h4 class="text-slate-900 font-semibold mb-3">Legal Resources</h4>
                        <ul class="space-y-2 text-sm">
                        <li><a href="https://dejure.org" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">dejure.org <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://beck-online.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">Beck-Online <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://juris.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">Juris <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        <li><a href="https://bundesanzeiger.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">Bundesanzeiger <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                        </ul>
                    </div>

                    <!-- Professional Associations -->
                    <div>
                        <h4 class="text-slate-900 font-semibold mb-3">Professional Associations</h4>
                        <ul class="space-y-2 text-sm">
                            <li><a href="https://anwaltverein.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">DAV <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                            <li><a href="https://brak.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">BRAK <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                            <li><a href="https://soldan.de" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors flex items-center gap-1">Soldan Institute <i data-lucide="external-link" class="w-3 h-3"></i></a></li>
                            <li><a href="#" class="text-blue-600 hover:text-blue-700 transition-colors">Support</a></li>
                        </ul>
                    </div>
                </div>

                <hr class="my-6">

                <!-- Bottom Section -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-6 text-xs">
                        <a href="#" class="text-blue-600 hover:text-blue-700 transition-colors">Data Protection</a>
                        <a href="#" class="text-blue-600 hover:text-blue-700 transition-colors">Imprint</a>
                        <a href="#" class="text-blue-600 hover:text-blue-700 transition-colors">Terms and Conditions</a>
                        <a href="#" class="text-blue-600 hover:text-blue-700 transition-colors">Cookies</a>
                    </div>
                    
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <span>Powered by</span>
                        <div class="flex items-center gap-1">
                            <i data-lucide="brain" class="w-3 h-3 text-purple-400"></i>
                            <span class="text-purple-400 font-medium">Advanced AI</span>
                        </div>
                    </div>
                </div>
            </div>
          </footer>
        </div>
      </section>
    </main>
    <!-- Drawers & Backdrops -->
    <div id="backdrop" class="backdrop" aria-hidden="true"></div>
    <div id="contextDrawer" class="drawer" role="dialog" aria-label="Kontext & Aktionen" aria-modal="true" aria-hidden="true">
      <div class="drawer-header">Kontext & Aktionen <button id="closeContext" class="btn-ghost" type="button">Schlie√üen</button></div>
      <div style="padding:12px; overflow:auto;">
        <!-- Mirror of context cards -->
        <div class="card" style="border-radius:10px; margin-bottom:8px;"><div class="card-body">Matter: Mandant, Gegner, Frist, Aktenzeichen</div></div>
        <div class="card" style="border-radius:10px; margin-bottom:8px;"><div class="card-body">Snippets/Templates: drag-drop</div></div>
        <div class="card" style="border-radius:10px; margin-bottom:8px;"><div class="card-body">Pr√ºf-Checkliste</div></div>
        <div class="card" style="border-radius:10px; margin-bottom:8px;"><div class="card-body">Export: DOCX | PDF | E-Mail | beA</div></div>
      </div>
    </div>
    <div id="threadsDrawer" class="drawer drawer-threads" role="dialog" aria-label="Threads" aria-modal="true" aria-hidden="true">
      <div class="drawer-header">Threads <button id="closeThreads" class="btn-ghost" type="button">Schlie√üen</button></div>
      <div style="padding:12px; overflow:auto;">
        <input class="search" type="search" placeholder="Suchen‚Ä¶" aria-label="Threads durchsuchen (mobil)" />
        <ul class="threads-list" style="margin-top:8px;">
          <li class="thread-item"><span>Erste Unterhaltung</span><span class="chip">Entwurf</span></li>
        </ul>
      </div>
    </div>

    <!-- Advanced settings sheet -->
    <div id="settingsSheet" class="drawer glass-sheet" role="dialog" aria-label="Einstellungen" aria-modal="true" aria-hidden="true" style="width:360px;">
      <div class="drawer-header">Einstellungen <button id="closeSettings" class="btn-ghost" type="button" aria-label="Schlie√üen" title="Schlie√üen" style="font-size:16px; line-height:1;">‚úï</button></div>
      <div style="padding:12px; display:flex; flex-direction:column; gap:10px;">
        <label class="tagline">Ziel<br/>
          <select id="setMode" style="width:100%; height:36px; border:1px solid var(--border); border-radius:8px; background:#fff; color:var(--text-900); padding:0 8px;">
            <option>Entwurf</option><option>Recherche</option><option>Pr√ºfen</option><option>√úbersetzen</option>
          </select>
        </label>
        <label class="tagline">Rechtsraum<br/>
          <select id="setJuris" style="width:100%; height:36px; border:1px solid var(--border); border-radius:8px; background:#fff; color:var(--text-900); padding:0 8px;">
            <option>DE (BGB)</option><option>EU</option><option>AT</option><option>CH</option>
          </select>
        </label>
        <label class="tagline">Sprache<br/>
          <select id="setLang" style="width:100%; height:36px; border:1px solid var(--border); border-radius:8px; background:#fff; color:var(--text-900); padding:0 8px;">
            <option>Deutsch</option><option>Englisch</option>
          </select>
        </label>
        <label class="tagline" style="display:flex; align-items:center; gap:8px;">
          <input id="setDoNotStore" type="checkbox"/>
          Nicht speichern (Thread)
        </label>
        <button id="applySettings" class="btn-primary" type="button" style="margin-top:6px;">√úbernehmen</button>
      </div>
    </div>

    <!-- Bottom tabs on small screens -->
    <div class="bottom-tabs" id="bottomTabs" style="display:none;">
      <button id="tabChat" type="button">Chat</button>
      <button id="tabThreads" type="button">Threads</button>
      <button id="tabContext" type="button">Kontext</button>
    </div>

    <!-- Removed fixed footer to restore previous look -->
  </div>

  <script>
    // Initialize Lucide so footer icons render correctly
    window.addEventListener('DOMContentLoaded', function(){
      try { if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons(); } catch(_) {}
    });

    // Minimal no-break placeholder logic; all endpoints prefixed under /api/assistant as per contract
    async function postJSON(url, data){
      const token = localStorage.getItem('anwalts_auth_token');
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{})}, body:JSON.stringify(data)});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json();
    }
    const FEAT_GUIDED = (localStorage.getItem('ASSISTANT_V1_GUIDED')||'true').toLowerCase() !== 'false';
    const FEAT_CHATGPT = (localStorage.getItem('ASSISTANT_CHATGPT')||'true').toLowerCase() !== 'false';
    let lastPrompt = '';
    let lastAssistant = '';

    // Onboarding banner logic
    (function(){
      const dismissed = localStorage.getItem('assistant_welcome_dismissed') === '1';
      const banner = document.getElementById('onboarding');
      if (FEAT_GUIDED && !dismissed) banner.style.display = 'none'; // hide by default
      const dismiss = document.getElementById('dismissOnboarding');
      const quick = document.getElementById('quickStartBtn');
      if (dismiss) dismiss.addEventListener('click', ()=>{ localStorage.setItem('assistant_welcome_dismissed','1'); banner.style.display='none'; });
      if (quick) quick.addEventListener('click', ()=>{
        const ex = 'Erstelle eine NDA zwischen Alpha GmbH und Beta AG, deutsches Recht, englische Sprache, Laufzeit 24 Monate, Gerichtsstand Berlin.';
        document.getElementById('input').value = ex;
        banner.style.display='none';
      });
    })();

    // Drawers
    const backdrop = document.getElementById('backdrop');
    const cDrawer = document.getElementById('contextDrawer');
    const tDrawer = document.getElementById('threadsDrawer');
    function openDrawer(el){ el.classList.add('open'); backdrop.classList.add('show'); el.setAttribute('aria-hidden','false'); }
    function closeDrawer(el){ el.classList.remove('open'); if(!cDrawer.classList.contains('open') && !tDrawer.classList.contains('open')) backdrop.classList.remove('show'); el.setAttribute('aria-hidden','true'); }
    const tCtx = document.getElementById('toggleContext'); if (tCtx) tCtx.addEventListener('click', ()=> openDrawer(cDrawer));
    const tThr = document.getElementById('toggleThreads'); if (tThr) tThr.addEventListener('click', ()=> openDrawer(tDrawer));
    const cClose = document.getElementById('closeContext'); if (cClose) cClose.addEventListener('click', ()=> closeDrawer(cDrawer));
    const tClose = document.getElementById('closeThreads'); if (tClose) tClose.addEventListener('click', ()=> closeDrawer(tDrawer));
    if (backdrop) backdrop.addEventListener('click', ()=>{ closeDrawer(cDrawer); closeDrawer(tDrawer); });

    // SimpleChat mode toggles
    if (FEAT_GUIDED && (localStorage.getItem('ASSISTANT_CLEAN_V1')||'true').toLowerCase() === 'false') document.getElementById('pillbar').style.display='flex';

    function renderMsgActions(container){
      const bar = document.createElement('div');
      bar.className = 'msg-actions';
      bar.innerHTML = `
        <button data-act="copy" title="Kopieren" aria-label="Kopieren"><i data-lucide="copy"></i></button>
        <button data-act="up" title="Hilfreich" aria-label="Hilfreich"><i data-lucide="thumbs-up"></i></button>
        <button data-act="down" title="Nicht hilfreich" aria-label="Nicht hilfreich"><i data-lucide="thumbs-down"></i></button>
        <button data-act="tts" title="Vorlesen" aria-label="Vorlesen"><i data-lucide="volume-2"></i></button>
        <button data-act="edit" title="Bearbeiten" aria-label="Antwort bearbeiten"><i data-lucide="edit-3"></i></button>
        <button data-act="share" title="Teilen" aria-label="Teilen"><i data-lucide="share-2"></i></button>
        <button data-act="regen" title="Neu generieren" aria-label="Neu generieren"><i data-lucide="refresh-ccw"></i></button>
      `;
      container.appendChild(bar);
      try { if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons(); } catch(_) {}
      attachActionHandlers(bar);
    }

    function attachActionHandlers(bar){
      bar.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const act = btn.getAttribute('data-act');
        const lastMsg = document.querySelector('.bubble-ai:last-of-type');
        let content = lastMsg ? (lastMsg.getAttribute('data-copy') || lastMsg.textContent || lastMsg.innerText || '') : '';
        if (!content && (typeof lastAssistant !== 'undefined') && lastAssistant) content = lastAssistant;
        if (act === 'copy'){
          try{
            try{ await navigator.clipboard.writeText(content); }
            catch(_){ const ta=document.createElement('textarea'); ta.value=content; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); }catch(e){} document.body.removeChild(ta); }
            const prev = btn.innerHTML; btn.innerHTML = '<i data-lucide="check"></i>';
            try { if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons(); } catch(_) {}
            toast('Kopiert');
            setTimeout(()=>{ btn.innerHTML = prev; try { if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons(); } catch(_) {} }, 1000);
          }catch(_){ toast('Kopieren fehlgeschlagen'); }
        }
        if (act === 'tts'){
          try{ const u=new SpeechSynthesisUtterance(content); speechSynthesis.speak(u);}catch(_){}
        }
        if (act === 'up'){ submitFeedback({ rating:+1, reasons:[] }, btn); }
        if (act === 'down'){ openReasonPicker((reasons)=> submitFeedback({ rating:-1, reasons }, btn)); }
        if (act === 'edit'){ openEditSheet(content, (payload)=> submitEdit(payload, btn)); }
        if (act === 'regen'){
          btn.classList.add('spin');
          try{ window.__doRegen = true; await regenerateLast(); } finally { setTimeout(()=>{ btn.classList.remove('spin'); }, 1600); }
        }
      });
    }

    function toast(msg){
      try{
        let el = document.getElementById('toast');
        if (!el){ el = document.createElement('div'); el.id='toast'; el.style.position='fixed'; el.style.bottom='16px'; el.style.right='16px'; el.style.background='#0f172a'; el.style.color='#fff'; el.style.padding='8px 10px'; el.style.borderRadius='8px'; el.style.boxShadow='0 6px 20px rgba(15,23,42,.35)'; el.style.zIndex='1000'; document.body.appendChild(el); }
        el.textContent = msg; el.style.opacity='1';
        clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=>{ el.style.opacity='0'; }, 1400);
      }catch(_){ try{ console.log(msg); }catch(__){} }
    }
    async function regenerateLast(){
      let txt = (lastPrompt||'').trim();
      if (!txt){
        const lastUser = document.querySelector('.bubble-user:last-of-type');
        txt = lastUser ? (lastUser.textContent||lastUser.innerText||'').trim() : '';
      }
      if (!txt){ toast('Kein vorheriger Prompt'); return; }
      const input = document.getElementById('input');
      input.value = txt; input.focus();
      document.getElementById('send').click();
    }
    function getIds(){
      const cid = localStorage.getItem('conv_id') || (localStorage.setItem('conv_id', cryptoRandom()), localStorage.getItem('conv_id'));
      const mid = cryptoRandom();
      return { conversation_id: cid, message_id: mid };
    }
    function cryptoRandom(){ try{ return crypto.randomUUID(); }catch(_){ return 'id_'+Math.random().toString(36).slice(2);} }

    async function submitFeedback({rating,reasons}, btn){
      try{
        const token = await ensureAuthToken();
        const ids = getIds();
        const res = await fetch('/api/assistant/feedback',{
          method:'POST', headers:{'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{})},
          body: JSON.stringify({ ...ids, rating, reasons, model:'qwen_legal_f16.gguf', message_hash:null, client_ts:new Date().toISOString() })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        btn.style.background = rating>0? '#d1fae5':'#fee2e2';
        setTimeout(()=>{ btn.style.background=''; }, 5000);
      }catch(e){ toast('Feedback fehlgeschlagen'); }
    }

    function openReasonPicker(onSubmit){
      const reasons = ['hallucination','keine Quelle','fachlich falsch','veraltet','zu lang','zu kurz','off-topic','toxisch/unangemessen','Format/Struktur schlecht','andere'];
      const pick = prompt('Grund (optional, kommasepariert):\n'+reasons.join(', '));
      const list = (pick||'').split(',').map(s=>s.trim()).filter(Boolean);
      onSubmit(list.length? list: ['andere']);
    }

    function openEditSheet(current, onSubmit){
      const text = prompt('Antwort verbessern (mind. 20 Zeichen):', current||'');
      if (!text || text.trim().length < 20) return toast('Zu kurz');
      const allow = confirm('F√ºr Training verwenden (anonymisiert)?');
      onSubmit({ edited_content: text, allow_training: allow });
    }

    async function submitEdit({edited_content, allow_training}, btn){
      try{
        const token = getAuthToken();
        const ids = getIds();
        const res = await fetch('/api/assistant/edit',{
          method:'POST', headers:{'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{})},
          body: JSON.stringify({ ...ids, edited_content, allow_training, message_hash:null, client_ts:new Date().toISOString() })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        toast('Danke! Verbesserung gespeichert.');
      }catch(e){ toast('Speichern fehlgeschlagen'); }
    }

    // Quick examples under composer
    (function(){
      const ex = [
        'Erstelle: Mahnung (1. Stufe)',
        'Entwurf: beidseitige NDA',
        'Pr√ºfe: hochgeladenen Vertrag',
        'Fasse PDF in 5 Punkten',
        '√úbersetze: Deutsch ‚Üí Englisch (jur.)'
      ];
      const wrap = document.getElementById('examples');
      const empty = document.getElementById('emptyChips');
      const chipsWrap = empty || wrap;
      ex.forEach(t=>{ const chip=document.createElement('button'); chip.type='button'; chip.className='example-chip'; chip.textContent=t; chip.addEventListener('click', ()=>{ document.getElementById('input').value = t; document.getElementById('input').focus(); }); chipsWrap.appendChild(chip); });
    })();

    // Attachments: previews only (no backend upload yet)
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    const previews = document.getElementById('previews');
    attachBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{
      previews.innerHTML='';
      Array.from(fileInput.files || []).slice(0,5).forEach(f=>{
        if (/image\//.test(f.type)){
          const img = document.createElement('img'); img.className='thumb'; img.alt=f.name; img.src = URL.createObjectURL(f); previews.appendChild(img);
        } else {
          const chip = document.createElement('span'); chip.className='file-chip'; chip.textContent = f.name; previews.appendChild(chip);
        }
      });
    });

    // Guided composer: Enter to send, Shift+Enter newline
    const inputEl = document.getElementById('input');
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('send').click(); }
    });

    let streaming = false; let streamTimer=null;

    function collectRecentContext(limit=6){
      try{
        const nodes = Array.from(document.querySelectorAll('#messages .bubble-user, #messages .bubble-ai'));
        const last = nodes.slice(-limit);
        return last.map(n=>({ role: n.classList.contains('bubble-user')?'user':'assistant', content: n.textContent||'' }));
      }catch(_){ return [] }
    }

    function buildComposedPrompt(currentUserInput){
      const turns = collectRecentContext(8);
      const convo = turns.map(t=>`${t.role.toUpperCase()}: ${t.content}`).join('\n');
      // Detect if we have an assistant turn to expand
      const lastAssistantEl = document.querySelector('#messages .bubble-ai:last-of-type');
      const userBubbles = Array.from(document.querySelectorAll('#messages .bubble-user'));
      const prevUserEl = userBubbles.length >= 2 ? userBubbles[userBubbles.length - 2] : null;
      const lastAssistantText = lastAssistantEl ? (lastAssistantEl.textContent||'').trim() : '';
      const prevUserText = prevUserEl ? (prevUserEl.textContent||'').trim() : '';

      const preface = "You are AnwaltsAI, a professional German legal assistant. Be concise, accurate, and contextual. Cite BGB/EGZPO/etc. where relevant. If the user requests an explanation (e.g., 'explain further'), expand the most recent relevant content with clear elements: Voraussetzungen (requirements), Rechtsfolgen (legal consequences), Fristen (deadlines), and practical options.";

      let directive = '';
      if (/(explain|erkl√§ren|mehr|further)/i.test(currentUserInput) && !lastAssistantText && prevUserText){
        directive = `\n\nContext to elaborate (from previous user message):\n"""\n${prevUserText}\n"""`;
      } else if (/(explain|erkl√§ren|mehr|further)/i.test(currentUserInput) && lastAssistantText){
        directive = `\n\nContext to elaborate (from previous assistant answer):\n"""\n${lastAssistantText}\n"""`;
      }

      return `${preface}\n\nConversation so far:\n${convo}${directive}\n\nUSER: ${currentUserInput}\nASSISTANT:`;
    }
    function stopStreaming(){ if (streamTimer){ clearInterval(streamTimer); streamTimer=null; streaming=false; } }
    document.getElementById('send').addEventListener('click', async()=>{
      const input = document.getElementById('input');
      const text = (input.value||'').trim();
      if(!text) return;
      lastPrompt = text;
      // Tryout gate: one free message if not logged in
      try {
        const user = localStorage.getItem('anwalts_user');
        const sent = parseInt(localStorage.getItem('tryout_sent')||'0',10);
        if (!user && sent >= 1){
          const transcript = Array.from(document.querySelectorAll('#messages .bubble-user, #messages .bubble-ai')).map(el=>({role: el.classList.contains('bubble-user')?'user':'assistant', content: el.textContent||''}));
          localStorage.setItem('tryout_conversation', JSON.stringify(transcript));
          // FIXED: Removed auto-modal trigger
          // localStorage.setItem('open_auth_modal','1');
          window.location.href = '/?message=free_limit_reached';
          return;
        }
      } catch(_) {}
      const messages = document.getElementById('messages');
      const emptyCard = document.getElementById('emptyState'); if (emptyCard) emptyCard.style.display='none';
      const me = document.createElement('div'); me.className = 'bubble-user'; me.textContent = text; messages.appendChild(me);
      input.value='';
      try{
        // Placeholder typing bubble
        const typing = document.createElement('div');
        typing.className = 'typing-bubble';
        typing.setAttribute('role','status');
        typing.setAttribute('aria-live','polite');
        const em = document.createElement('em'); em.className='typing-text'; em.textContent='Anwalts-KI schreibt';
        typing.appendChild(em);
        messages.appendChild(typing);

        // Fallback single-call; simulate streaming replacing typing bubble
        let aiText = '';
        const token = getAuthToken();
        const isRegen = !!window.__doRegen;
        if (isRegen) { window.__regenCount = (window.__regenCount||0)+1; } else { window.__regenCount = 0; }
        window.__doRegen = false;
        const basePrompt = (window.__regenCount||0) > 0 ? perturbPrompt(text, window.__regenCount||1) : text;
        const reqPrompt = buildComposedPrompt(basePrompt);
        const useTemp = (window.__regenCount||0) > 0 ? 0.38 : 0.3;
        const payload = { prompt: reqPrompt, model: undefined, max_tokens: 800, temperature: useTemp, context: JSON.stringify(collectRecentContext(8)) };
        if (isRegen) payload.seed = Math.floor(Math.random()*2147483647);

        async function callAiComplete() {
          const res = await fetch('/api/ai/complete', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', ...(token?{Authorization:'Bearer '+token}:{}) },
            credentials: 'include',
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            // Treat 401/403 or any error as fallback trigger
            throw new Error('primary_failed_' + res.status);
          }
          const data = await res.json();
          return (data && (data.content || data.document?.content)) || '';
        }

        async function callAiTest() {
          const res2 = await fetch('/api/ai/complete-test', {
            method:'POST', headers:{ 'Content-Type':'application/json' },
            credentials: 'include',
            body: JSON.stringify({ prompt: text, max_tokens: 300 })
          });
          if (!res2.ok) throw new Error('fallback_failed_' + res2.status);
          const data2 = await res2.json();
          return data2 && (data2.content || data2.document?.content) || '';
        }

        try {
          if (token) {
            aiText = await callAiComplete();
          } else {
            aiText = await callAiTest();
          }
        } catch (e) {
          try { aiText = await callAiTest(); } catch(_) {
            aiText = 'Bitte melden Sie sich an, um den KI‚ÄëAssistenten zu verwenden.';
          }
        }
        // Replace typing
        typing.remove();
        const ai = document.createElement('div'); ai.className = 'bubble-ai'; messages.appendChild(ai);
        // If response is a legal JSON contract, render a neat card instead of raw text
        if (isProbablyJson(aiText)){
          try {
            const obj = JSON.parse(extractJson(aiText));
            if (obj && (obj.answer || obj.classification || obj.citations)){
              ai.innerHTML = '';
              ai.appendChild(renderLegalJsonMessage(obj));
              try{ ai.setAttribute('data-copy', aiText); }catch(_){ }
              lastAssistant = aiText;
              messages.scrollTop = messages.scrollHeight;
              renderMsgActions(messages);
              return;
            }
          } catch(_) { /* fall back to streaming */ }
        }
        // Otherwise stream plain text for ChatGPT-like feel
        streaming = true; let i=0;
        streamTimer = setInterval(()=>{
          if (i >= aiText.length){
            stopStreaming();
            try{ ai.setAttribute('data-copy', aiText); }catch(_){ }
            lastAssistant = aiText;
            try { const user = localStorage.getItem('anwalts_user'); if (!user){ localStorage.setItem('tryout_sent', String((parseInt(localStorage.getItem('tryout_sent')||'0',10)) + 1)); } } catch(_){ }
            renderMsgActions(messages);
            return;
          }
          ai.textContent += aiText.slice(i, i+Math.max(1, Math.floor(aiText.length/200)));
          i += Math.max(1, Math.floor(aiText.length/200));
          messages.scrollTop = messages.scrollHeight;
        }, 30);
      }catch(e){
        const err = document.createElement('div'); err.className = 'bubble-ai'; err.textContent = 'Fehler: '+e.message; messages.appendChild(err);
      }
      messages.scrollTop = messages.scrollHeight;
    });

    // Clean controls: privacy toggle and settings sheet
    const privacyBtn = document.getElementById('privacyToggle');
    if (privacyBtn) privacyBtn.addEventListener('click', ()=>{ privacyBtn.textContent = (privacyBtn.textContent === 'Nur ich' ? 'Team' : 'Nur ich'); });

    const sBtn = document.getElementById('openSettings');
    const sSheet = document.getElementById('settingsSheet');
    const sClose = document.getElementById('closeSettings');
    const sApply = document.getElementById('applySettings');
    function openSettings(){ sSheet.classList.add('open'); backdrop.classList.add('show'); sSheet.setAttribute('aria-hidden','false'); }
    function closeSettings(){ sSheet.classList.remove('open'); if(!cDrawer.classList.contains('open') && !tDrawer.classList.contains('open')) backdrop.classList.remove('show'); sSheet.setAttribute('aria-hidden','true'); }
    if (sBtn) sBtn.addEventListener('click', openSettings);
    if (sClose) sClose.addEventListener('click', closeSettings);
    if (sApply) sApply.addEventListener('click', closeSettings);

    // Scroll-to-bottom control
    const scrollBtn = document.createElement('button'); scrollBtn.id='scrollDown'; scrollBtn.title='Zum Ende springen'; scrollBtn.textContent='‚Üì';
    document.body.appendChild(scrollBtn);
    const messagesEl = document.getElementById('messages');
    function updateScrollBtn(){
      const nearBottom = messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight < 64;
      scrollBtn.classList.toggle('show', !nearBottom);
    }
    messagesEl.addEventListener('scroll', updateScrollBtn);
    scrollBtn.addEventListener('click', ()=>{ messagesEl.scrollTo({ top: messagesEl.scrollHeight, behavior: 'smooth' }); });

    // Stop button support (appears only when streaming) via ESC
    document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') stopStreaming(); });

    // Tryout restore: if landing set restore_tryout, replay transcript
    (function(){
      try{
        if (localStorage.getItem('restore_tryout') === '1'){
          const raw = localStorage.getItem('tryout_conversation');
          const list = raw? JSON.parse(raw): [];
          const messages = document.getElementById('messages');
          if (messages && Array.isArray(list)){
            list.forEach(m=>{
              const el = document.createElement('div');
              el.className = m.role === 'user' ? 'bubble-user' : 'bubble-ai';
              el.textContent = m.content || '';
              messages.appendChild(el);
            });
            messages.scrollTop = messages.scrollHeight;
          }
          localStorage.removeItem('restore_tryout');
        }
      }catch(_){}
    })();

    // ---------- Pretty rendering for legal JSON contracts ----------
    function isProbablyJson(txt){ if (!txt) return false; const s = String(txt).trim(); return s.startsWith('{') && s.endsWith('}'); }
    function extractJson(txt){ const s=String(txt); const a=s.indexOf('{'); const b=s.lastIndexOf('}'); return (a>=0 && b>=0)? s.slice(a,b+1): s; }
    function el(tag, attrs={}, children=[]) {
      const e=document.createElement(tag);
      Object.entries(attrs||{}).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); });
      (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>{ if(typeof c==='string'){ e.appendChild(document.createTextNode(c)); } else { e.appendChild(c);} });
      return e;
    }
    function renderKeyVal(label, value){
      if (!value) return null;
      return el('div', {class:'tagline', style:'margin:4px 0;'}, [ el('strong',{},[label+': ']), value ]);
    }
    function renderCitations(list){
      if (!Array.isArray(list) || list.length===0) return null;
      const ul = el('ul', {class:'', style:'margin:6px 0 0 16px;'});
      list.forEach(c=>{
        const text = (c && c.ref)? String(c.ref) : '';
        ul.appendChild(el('li',{},[ text ]));
      });
      return el('div',{},[ el('div',{class:'tagline',style:'font-weight:600;margin-top:8px;'},['Zitate']), ul ]);
    }
    function renderMissing(list){
      if (!Array.isArray(list) || list.length===0) return null;
      const ul = el('ul', {style:'margin:6px 0 0 16px;'});
      list.slice(0,3).forEach(q=> ul.appendChild(el('li',{},[q])));
      return el('div',{},[ el('div',{class:'tagline',style:'font-weight:600;margin-top:8px;'},['Offene Punkte']), ul ]);
    }
    function renderLegalJsonMessage(obj){
      const wrap = el('div');
      if (obj.answer) wrap.appendChild(el('div',{class:'',style:'margin-bottom:6px;'},[obj.answer]));
      if (obj.classification){
        const c = obj.classification || {};
        wrap.appendChild(el('div',{class:'tagline',style:'font-weight:600;margin-top:6px;'},['Klassifikation']));
        wrap.appendChild(renderKeyVal('Typ', c.error_type));
        wrap.appendChild(renderKeyVal('Kausalit√§t', c.causality));
        wrap.appendChild(renderKeyVal('Frist', c.deadline));
        wrap.appendChild(renderKeyVal('Wirkungen', c.effects));
        ['seller_duties','buyer_duties','breach','remedies','protected_right','conduct','causation','unlawfulness','fault','damage','preconditions','exceptions','start_of_default','interest','basis']
          .forEach(k=>{ if (c[k]) wrap.appendChild(renderKeyVal(k.replaceAll('_',' '), c[k])); });
      }
      const cit = renderCitations(obj.citations);
      if (cit) wrap.appendChild(cit);
      const miss = renderMissing(obj.missing_facts);
      if (miss) wrap.appendChild(miss);
      wrap.style.display='block';
      return wrap;
    }

    function perturbPrompt(text, n){
      try{
        const invis = ['\u200B','\u200C','\u2060','\uFEFF'];
        let out = text;
        for(let i=0;i<Math.max(1,n);i++){
          const ch = invis[i % invis.length];
          const idx = Math.min(Math.max(1, Math.floor(out.length/2)+i), Math.max(1,out.length-1));
          out = out.slice(0, idx) + ch + out.slice(idx);
        }
        return out;
      }catch(_){ return text; }
    }
  </script>
</body>
</html>
